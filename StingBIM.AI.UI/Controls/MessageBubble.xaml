<UserControl x:Class="StingBIM.AI.UI.Controls.MessageBubble"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             x:Name="Root"
             SizeChanged="Root_SizeChanged">

    <UserControl.Resources>
        <!-- User message style - MaxWidth bound dynamically for responsive layout -->
        <Style x:Key="UserBubbleStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource UserBubbleBrush}"/>
            <Setter Property="CornerRadius" Value="16,16,4,16"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="48,4,8,4"/>
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <!-- MaxWidth set dynamically in code-behind based on container width -->
        </Style>

        <!-- Assistant message style - MaxWidth bound dynamically for responsive layout -->
        <Style x:Key="AssistantBubbleStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource AssistantBubbleBrush}"/>
            <Setter Property="CornerRadius" Value="16,16,16,4"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="8,4,48,4"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <!-- MaxWidth set dynamically in code-behind based on container width -->
        </Style>

        <!-- Error message style - MaxWidth bound dynamically for responsive layout -->
        <Style x:Key="ErrorBubbleStyle" TargetType="Border">
            <Setter Property="Background" Value="{DynamicResource ErrorBubbleBrush}"/>
            <Setter Property="CornerRadius" Value="16,16,16,4"/>
            <Setter Property="Padding" Value="12,8"/>
            <Setter Property="Margin" Value="8,4,48,4"/>
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <!-- MaxWidth set dynamically in code-behind based on container width -->
            <Setter Property="BorderBrush" Value="{DynamicResource ErrorBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
        </Style>

        <!-- Action Button Style -->
        <Style x:Key="MessageActionButtonStyle" TargetType="Button">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="0"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="Opacity" Value="0.6"/>
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="Template">
                <Setter.Value>
                    <ControlTemplate TargetType="Button">
                        <Border Background="{TemplateBinding Background}"
                                CornerRadius="4"
                                Padding="{TemplateBinding Padding}">
                            <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                        </Border>
                        <ControlTemplate.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Opacity" Value="1"/>
                                <Setter Property="Background" Value="{DynamicResource CardBrush}"/>
                            </Trigger>
                        </ControlTemplate.Triggers>
                    </ControlTemplate>
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Feedback Button Styles -->
        <Style x:Key="ThumbsUpButtonStyle" TargetType="Button" BasedOn="{StaticResource MessageActionButtonStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding FeedbackGiven, ElementName=Root}" Value="Positive">
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Background" Value="{DynamicResource SuccessBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ThumbsDownButtonStyle" TargetType="Button" BasedOn="{StaticResource MessageActionButtonStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding FeedbackGiven, ElementName=Root}" Value="Negative">
                    <Setter Property="Opacity" Value="1"/>
                    <Setter Property="Background" Value="{DynamicResource ErrorBrush}"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </UserControl.Resources>

    <Grid>
        <!-- User Message -->
        <Border x:Name="UserBubble"
                Style="{StaticResource UserBubbleStyle}"
                Visibility="Collapsed">
            <TextBlock Text="{Binding Text, ElementName=Root}"
                       TextWrapping="Wrap"
                       Foreground="{DynamicResource UserTextBrush}"
                       FontSize="13"/>
        </Border>

        <!-- Assistant Message -->
        <Grid x:Name="AssistantContainer" Visibility="Collapsed">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Avatar -->
            <Ellipse Grid.Column="0" Width="28" Height="28"
                     Fill="{DynamicResource AccentBrush}"
                     Margin="8,4,0,4"
                     VerticalAlignment="Top">
                <Ellipse.Effect>
                    <DropShadowEffect Color="{DynamicResource AccentColor}"
                                      BlurRadius="4" ShadowDepth="0" Opacity="0.3"/>
                </Ellipse.Effect>
            </Ellipse>
            <TextBlock Grid.Column="0" Text="AI"
                       Foreground="White" FontWeight="Bold" FontSize="10"
                       HorizontalAlignment="Center" VerticalAlignment="Top"
                       Margin="8,12,0,0"/>

            <!-- Message Bubble with Actions -->
            <StackPanel Grid.Column="1">
                <Border x:Name="AssistantBubble" Style="{StaticResource AssistantBubbleStyle}">
                    <StackPanel>
                        <TextBlock Text="{Binding Text, ElementName=Root}"
                                   TextWrapping="Wrap"
                                   Foreground="{DynamicResource AssistantTextBrush}"
                                   FontSize="13"/>

                        <!-- Timestamp -->
                        <TextBlock x:Name="TimestampText"
                                   FontSize="10" Opacity="0.5"
                                   Foreground="{DynamicResource AssistantTextBrush}"
                                   HorizontalAlignment="Right"
                                   Margin="0,4,0,0"/>
                    </StackPanel>
                </Border>

                <!-- Action Buttons (show on hover) -->
                <StackPanel x:Name="ActionsPanel"
                            Orientation="Horizontal"
                            HorizontalAlignment="Left"
                            Margin="8,2,0,0"
                            Opacity="0">
                    <!-- Copy Button -->
                    <Button Style="{StaticResource MessageActionButtonStyle}"
                            Click="CopyButton_Click"
                            ToolTip="Copy to clipboard">
                        <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="14" Height="14" Stretch="Uniform"/>
                    </Button>

                    <!-- Retry Button -->
                    <Button Style="{StaticResource MessageActionButtonStyle}"
                            Click="RetryButton_Click"
                            ToolTip="Regenerate response">
                        <Path Data="M17.65,6.35C16.2,4.9 14.21,4 12,4A8,8 0 0,0 4,12A8,8 0 0,0 12,20C15.73,20 18.84,17.45 19.73,14H17.65C16.83,16.33 14.61,18 12,18A6,6 0 0,1 6,12A6,6 0 0,1 12,6C13.66,6 15.14,6.69 16.22,7.78L13,11H20V4L17.65,6.35Z"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="14" Height="14" Stretch="Uniform"/>
                    </Button>

                    <!-- Separator -->
                    <Border Width="1" Height="16" Background="{DynamicResource BorderBrush}" Margin="4,0"/>

                    <!-- Thumbs Up -->
                    <Button x:Name="ThumbsUpButton"
                            Style="{StaticResource ThumbsUpButtonStyle}"
                            Click="ThumbsUpButton_Click"
                            ToolTip="Good response">
                        <Path Data="M23,10C23,8.89 22.1,8 21,8H14.68L15.64,3.43C15.66,3.33 15.67,3.22 15.67,3.11C15.67,2.7 15.5,2.32 15.23,2.05L14.17,1L7.59,7.58C7.22,7.95 7,8.45 7,9V19A2,2 0 0,0 9,21H18C18.83,21 19.54,20.5 19.84,19.78L22.86,12.73C22.95,12.5 23,12.26 23,12V10M1,21H5V9H1V21Z"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="14" Height="14" Stretch="Uniform"/>
                    </Button>

                    <!-- Thumbs Down -->
                    <Button x:Name="ThumbsDownButton"
                            Style="{StaticResource ThumbsDownButtonStyle}"
                            Click="ThumbsDownButton_Click"
                            ToolTip="Poor response">
                        <Path Data="M19,15H23V3H19M15,3H6C5.17,3 4.46,3.5 4.16,4.22L1.14,11.27C1.05,11.5 1,11.74 1,12V14A2,2 0 0,0 3,16H9.31L8.36,20.57C8.34,20.67 8.33,20.77 8.33,20.88C8.33,21.3 8.5,21.67 8.77,21.94L9.83,23L16.41,16.41C16.78,16.05 17,15.55 17,15V5C17,3.89 16.1,3 15,3Z"
                              Fill="{DynamicResource ForegroundSecondaryBrush}"
                              Width="14" Height="14" Stretch="Uniform"/>
                    </Button>
                </StackPanel>
            </StackPanel>
        </Grid>

        <!-- Error Message -->
        <Grid x:Name="ErrorContainer" Visibility="Collapsed">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Error Icon -->
            <Ellipse Grid.Column="0" Width="28" Height="28"
                     Fill="{DynamicResource ErrorBrush}"
                     Margin="8,4,0,4"
                     VerticalAlignment="Top"/>
            <Path Grid.Column="0"
                  Data="M13,13H11V7H13M13,17H11V15H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"
                  Fill="White" Width="16" Height="16" Stretch="Uniform"
                  HorizontalAlignment="Center" VerticalAlignment="Top"
                  Margin="8,10,0,0"/>

            <!-- Error Bubble with Expandable Details -->
            <Border x:Name="ErrorBubble"
                    Grid.Column="1"
                    Style="{StaticResource ErrorBubbleStyle}">
                <StackPanel>
                    <!-- Error Header -->
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <!-- Error Code Badge -->
                        <StackPanel Grid.Column="0" Orientation="Horizontal">
                            <Border x:Name="ErrorCodeBadge"
                                    Background="{DynamicResource ErrorBrush}"
                                    CornerRadius="4"
                                    Padding="6,2"
                                    Margin="0,0,8,4"
                                    Visibility="Collapsed">
                                <TextBlock x:Name="ErrorCodeText"
                                           Text=""
                                           FontSize="10"
                                           FontWeight="SemiBold"
                                           Foreground="White"/>
                            </Border>
                        </StackPanel>

                        <!-- Copy Button -->
                        <Button Grid.Column="1"
                                x:Name="CopyErrorButton"
                                Click="CopyErrorButton_Click"
                                ToolTip="Copy error details"
                                Background="Transparent"
                                BorderThickness="0"
                                Padding="4"
                                Cursor="Hand"
                                Opacity="0.6">
                            <Path Data="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"
                                  Fill="{DynamicResource ErrorTextBrush}"
                                  Width="14" Height="14" Stretch="Uniform"/>
                        </Button>
                    </Grid>

                    <!-- Error Message -->
                    <TextBlock Text="{Binding Text, ElementName=Root}"
                               TextWrapping="Wrap"
                               Foreground="{DynamicResource ErrorTextBrush}"
                               FontSize="13"/>

                    <!-- Expandable Details Section -->
                    <Expander x:Name="DetailsExpander"
                              Header="Show details"
                              Visibility="Collapsed"
                              Margin="0,8,0,0"
                              Foreground="{DynamicResource ErrorTextBrush}"
                              FontSize="11">
                        <Border Background="#10000000"
                                CornerRadius="4"
                                Padding="8"
                                Margin="0,4,0,0">
                            <TextBlock x:Name="ErrorDetailsText"
                                       TextWrapping="Wrap"
                                       FontFamily="Consolas"
                                       FontSize="11"
                                       Foreground="{DynamicResource ErrorTextBrush}"/>
                        </Border>
                    </Expander>

                    <!-- Timestamp -->
                    <TextBlock x:Name="ErrorTimestampText"
                               FontSize="10" Opacity="0.5"
                               Foreground="{DynamicResource ErrorTextBrush}"
                               HorizontalAlignment="Right"
                               Margin="0,4,0,0"/>
                </StackPanel>
            </Border>
        </Grid>

        <!-- System Message -->
        <Grid x:Name="SystemContainer" Visibility="Collapsed">
            <Border x:Name="SystemBubble"
                    Background="{DynamicResource CardBrush}"
                    CornerRadius="8"
                    Padding="12,8"
                    Margin="24,8"
                    HorizontalAlignment="Center">
                <!-- MaxWidth set dynamically in code-behind based on container width -->
                <StackPanel>
                    <TextBlock Text="{Binding Text, ElementName=Root}"
                               TextWrapping="Wrap"
                               Foreground="{DynamicResource ForegroundSecondaryBrush}"
                               FontSize="12"
                               TextAlignment="Center"/>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</UserControl>
